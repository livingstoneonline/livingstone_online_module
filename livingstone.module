<?php

/**
 * @file
 * An viewer for manuscripts with a TEI datastream.
 */

/**
 * Implements hook_menu().
 */
function livingstone_menu() {
  return array(
    'livingstone-viewer/%' => array(
      'title' => 'Manuscript Viewer Test',
      'access arguments' => array('access content'),
      'type' => MENU_NORMAL_ITEM,
      'page callback' => 'livingstone_manuscript_viewer',
      'page arguments' => array(1),
    ),
    'livingstone-tei/%' => array(
      'title' => 'Manuscript Viewer TEI',
      'access arguments' => array('access content'),
      'type' => MENU_NORMAL_ITEM,
      'page callback' => 'livingstone_manuscript_viewer_transcript',
      'page arguments' => array(1),
    )
  );
}

/**
 * Implements hook_menu_alter().
 */
function livingstone_menu_alter(&$items) {
  if (isset($items['islandora/search'])) {
    $search_item = &$items['islandora/search'];
    $search_item['page callback'] = 'livingstone_browse_catalogue';
  }
}

/**
 * Custom Solr Search Results page for the standard catalogue.
 *
 * @param string|null $query
 *   The search query.
 *
 * @return array
 *   The search form and results.
 */
function livingstone_browse_catalogue($query = NULL) {
  module_load_include('inc', 'livingstone', 'includes/browse.catalogue');
  return drupal_get_form('livingstone_browse_catalogue_form', $query);
}

/**
 * Callback to render the viewer.
 */
function livingstone_manuscript_viewer($manuscript = "liv:000490", $display_page = 0) {
  global $language;
  drupal_add_http_header('Content-Type', 'text/html; charset=utf-8');
  drupal_add_http_header('Content-Language', $language->language);
  return array(
    '#type' => 'page',
    '#theme_wrappers' => array('livingstone_manuscript_html'),
    'content' => array(
      '#theme' => 'livingstone_manuscript_viewer',
      '#manuscript' => $manuscript,
      '#display_page' => isset($display_page) ? $display_page : 0,
    ),
  );
}

/**
 * Callback to render the TEI transcription as HTML.
 *
 * @todo Remove? or make as a separate iframe.
 *
 * @param string $manuscript
 *   The PID of the manuscript.
 * @param int $page
 *   The page of the transcription to render.
 */
function livingstone_manuscript_viewer_transcript($manuscript, $display_page = 0) {
  global $language;
  drupal_add_http_header('Content-Type', 'text/html; charset=utf-8');
  drupal_add_http_header('Content-Language', $language->language);
  return array(
    '#theme' => 'livingstone_manuscript_transcript',
    '#manuscript' => $manuscript,
    '#display_page' => isset($display_page) ? $display_page : 0,
  );
}

/**
 * Implements hook_theme().
 */
function livingstone_theme() {
  // Solution packs using this as a viewer need to set these variables.
  return array(
    'livingstone_manuscript_html' => array(
      'file' => 'theme/theme.inc',
      'template' => 'theme/livingstone-manuscript-html',
      'render element' => 'page',
    ),
    'livingstone_manuscript_viewer' => array(
      'file' => 'theme/theme.inc',
      'template' => 'theme/livingstone-manuscript-viewer',
      'variables' => array(
        // PID of the Manuscript object (Required).
        'manuscript' => NULL,
        // Page to display (Required).
        'display_page' => NULL,
      ),
    ),
    'livingstone_manuscript_item_details' => array(
      'file' => 'theme/theme.inc',
      'template' => 'theme/livingstone-manuscript-item-details',
      'variables' => array(
        // PID of the Manuscript object (Required).
        'manuscript' => NULL,
      ),
    ),
    'livingstone_manuscript_transcript' => array(
      'file' => 'theme/theme.inc',
      'variables' => array(
        // PID of the Manuscript object (Required).
        'manuscript' => NULL,
        // Page to render out (Required).
        'display_page' => NULL,
      ),
    ),
    'livingstone_browse_catalogue_search' => array(
      'file' => 'includes/browse.catalogue.inc',
      'render element' => 'element',
      'template' => 'theme/livingstone-browse-catalogue-search',
    ),
    'livingstone_browse_catalogue_date_range' => array(
      'file' => 'includes/browse.catalogue.inc',
      'render element' => 'element',
      'template' => 'theme/livingstone-browse-catalogue-date-range',
    ),
  );
}
